// Prisma Schema for CronOps - Cron Job Scheduling Platform

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  name         String?
  refreshToken String?
  isVerified   Boolean   @default(false)
  otp          String?
  otpExpiresAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  cronJobs CronJob[]

  @@map("users")
}

model CronJob {
  id             String        @id @default(uuid())
  userId         String
  name           String
  cronExpression String
  timezone       String        @default("UTC")
  targetType     TargetType
  targetUrl      String?       // For HTTP jobs
  command        String?       // For SCRIPT jobs
  headers        Json?         // HTTP headers for HTTP jobs
  httpMethod     HttpMethod    @default(GET)
  payload        Json?         // Request body for HTTP jobs
  status         JobStatus     @default(ACTIVE)
  retryCount     Int           @default(0)
  maxRetries     Int           @default(3)
  timeout        Int           @default(30000) // milliseconds
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  executionLogs  ExecutionLog[]

  @@index([userId])
  @@index([status])
  @@map("cron_jobs")
}

model ExecutionLog {
  id           String          @id @default(uuid())
  jobId        String
  status       ExecutionStatus
  responseCode Int?
  responseBody String?
  errorMessage String?
  startedAt    DateTime
  finishedAt   DateTime?
  duration     Int?            // milliseconds
  createdAt    DateTime        @default(now())

  cronJob      CronJob         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
  @@index([startedAt])
  @@map("execution_logs")
}

enum TargetType {
  HTTP
  SCRIPT
}

enum JobStatus {
  ACTIVE
  PAUSED
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum ExecutionStatus {
  SUCCESS
  FAILED
  RUNNING
  TIMEOUT
}
